<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-ETL Data Explorer</title>
    <link rel="stylesheet" href="/static/leaflet.css" />
    <script src="/static/leaflet.js"></script>
    <style>
        :root {
            --bg: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --text: #eee;
            --text-muted: #888;
            --primary: #e94560;
            --success: #4ade80;
            --warning: #fbbf24;
            --error: #f87171;
            --border: #334155;
        }

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
        }

        header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        nav {
            display: flex;
            gap: 1rem;
        }

        nav a {
            color: var(--text-muted);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            transition: background 0.15s;
        }

        nav a:hover, nav a.active {
            background: var(--bg-card);
            color: var(--text);
        }

        main {
            flex: 1;
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 1px;
            background: var(--border);
            min-height: 0;
            overflow: hidden;
        }

        .sidebar {
            grid-row: 1 / -1;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 500;
        }

        .table-list {
            flex: 1;
            overflow-y: auto;
        }

        .schema-group {
            border-bottom: 1px solid var(--border);
        }

        .schema-header {
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
        }

        .table-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.15s;
        }

        .table-item:hover {
            background: var(--bg-card);
        }

        .table-item.selected {
            background: rgba(233, 69, 96, 0.2);
            border-left: 3px solid var(--primary);
        }

        .table-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-name .icon {
            font-size: 0.875rem;
        }

        .table-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .geo-badge {
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            background: var(--success);
            color: #000;
            margin-left: 0.5rem;
        }

        .data-panel {
            background: var(--bg);
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            font-size: 1rem;
            font-weight: 500;
        }

        .panel-actions {
            display: flex;
            gap: 0.5rem;
        }

        button, select {
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
        }

        select {
            min-width: 140px;
        }

        select:focus {
            outline: 2px solid var(--primary);
            outline-offset: -2px;
        }

        button:hover:not(:disabled) {
            background: var(--primary);
            border-color: var(--primary);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.primary {
            background: var(--primary);
            border-color: var(--primary);
        }

        .data-table-wrapper {
            flex: 1;
            overflow: auto;
            min-height: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }

        th, td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        th {
            background: var(--bg-secondary);
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .col-type {
            font-size: 0.625rem;
            color: var(--text-muted);
            display: block;
        }

        tr:hover td {
            background: rgba(255,255,255,0.02);
        }

        .map-panel {
            background: var(--bg);
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        #map {
            flex: 1;
            min-height: 0;
            background: #1a1a1a;
        }

        .pagination {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
        }

        .pagination-controls {
            display: flex;
            gap: 0.5rem;
        }

        .empty-state {
            padding: 3rem;
            text-align: center;
            color: var(--text-muted);
        }

        .sql-panel {
            padding: 1rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .sql-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            background: var(--bg);
            color: var(--text);
            font-family: 'Consolas', monospace;
            font-size: 0.875rem;
            resize: vertical;
            min-height: 60px;
        }

        .sql-input:focus {
            outline: 2px solid var(--primary);
            outline-offset: -2px;
        }

        .sql-actions {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Leaflet dark theme overrides */
        .leaflet-container {
            background: #1a1a1a;
        }

        .leaflet-popup-content-wrapper {
            background: var(--bg-secondary);
            color: var(--text);
            border-radius: 0.25rem;
        }

        .leaflet-popup-tip {
            background: var(--bg-secondary);
        }

        .leaflet-popup-content {
            font-size: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .popup-table {
            width: 100%;
        }

        .popup-table td {
            padding: 0.25rem 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .popup-table td:first-child {
            color: var(--text-muted);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <header>
        <h1>G-ETL Data Explorer</h1>
        <nav>
            <a href="/">Pipeline</a>
            <a href="/explorer" class="active">Data Explorer</a>
        </nav>
    </header>

    <main>
        <aside class="sidebar">
            <div class="sidebar-header">Tabeller</div>
            <div class="table-list" id="tableList">
                <div class="loading">
                    <div class="spinner"></div>
                    Laddar...
                </div>
            </div>
            <div class="sql-panel">
                <textarea class="sql-input" id="sqlInput" placeholder="SELECT * FROM staging.naturreservat LIMIT 10"></textarea>
                <div class="sql-actions">
                    <button class="primary" id="btnRunQuery">K√∂r SQL</button>
                </div>
            </div>
        </aside>

        <div class="data-panel">
            <div class="panel-header">
                <h2 id="dataTitle">V√§lj en tabell</h2>
                <div class="panel-actions">
                    <button id="btnRefresh" disabled>Uppdatera</button>
                    <button id="btnExportCsv" disabled>Exportera CSV</button>
                </div>
            </div>
            <div class="data-table-wrapper" id="dataTableWrapper">
                <div class="empty-state">
                    V√§lj en tabell i sidomenyn f√∂r att visa data
                </div>
            </div>
            <div class="pagination" id="pagination" style="display: none;">
                <span id="paginationInfo">Visar 0-0 av 0</span>
                <div class="pagination-controls">
                    <button id="btnPrev" disabled>F√∂reg√•ende</button>
                    <button id="btnNext" disabled>N√§sta</button>
                </div>
            </div>
        </div>

        <div class="map-panel">
            <div class="panel-header">
                <h2>Karta</h2>
                <div class="panel-actions">
                    <select id="sourceCrs" title="K√§llans koordinatsystem">
                        <option value="EPSG:3006" selected>SWEREF99 TM (3006)</option>
                        <option value="EPSG:3857">Web Mercator (3857)</option>
                        <option value="EPSG:4326">WGS84 (4326)</option>
                        <option value="EPSG:3021">RT90 2.5 gon V (3021)</option>
                    </select>
                    <button id="btnReloadGeo">Ladda om</button>
                    <button id="btnFitBounds" disabled>Zooma till data</button>
                </div>
            </div>
            <div id="map"></div>
        </div>
    </main>

    <script>
        // State
        let currentTable = null;
        let currentOffset = 0;
        const pageSize = 100;
        let map = null;
        let geoJsonLayer = null;

        // Initialize map
        function initMap() {
            map = L.map('map').setView([62.0, 15.0], 4);

            // Dark tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            geoJsonLayer = L.geoJSON(null, {
                style: {
                    color: '#e94560',
                    weight: 2,
                    fillColor: '#e94560',
                    fillOpacity: 0.3
                },
                pointToLayer: (feature, latlng) => {
                    return L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: '#e94560',
                        color: '#fff',
                        weight: 1,
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: (feature, layer) => {
                    if (feature.properties) {
                        const rows = Object.entries(feature.properties)
                            .filter(([k, v]) => v !== null)
                            .map(([k, v]) => `<tr><td>${k}</td><td>${v}</td></tr>`)
                            .join('');
                        layer.bindPopup(`<table class="popup-table">${rows}</table>`);
                    }
                }
            }).addTo(map);
        }

        // Load table list
        async function loadTables() {
            const listEl = document.getElementById('tableList');

            try {
                const response = await fetch('/api/explorer/tables');
                const data = await response.json();

                // Group by schema
                const grouped = {};
                for (const table of data.tables) {
                    if (!grouped[table.schema]) {
                        grouped[table.schema] = [];
                    }
                    grouped[table.schema].push(table);
                }

                // Render
                let html = '';
                for (const schema of ['raw', 'staging', 'mart']) {
                    const tables = grouped[schema] || [];
                    if (tables.length === 0) continue;

                    html += `<div class="schema-group">
                        <div class="schema-header">${schema} (${tables.length})</div>`;

                    for (const t of tables) {
                        const geoBadge = t.has_geometry ? '<span class="geo-badge">GEO</span>' : '';
                        html += `
                            <div class="table-item" data-schema="${t.schema}" data-table="${t.name}" data-has-geo="${t.has_geometry}">
                                <div class="table-name">
                                    <span class="icon">${t.has_geometry ? 'üó∫Ô∏è' : 'üìä'}</span>
                                    ${t.name}${geoBadge}
                                </div>
                                <div class="table-meta">${t.row_count.toLocaleString()} rader ¬∑ ${t.columns.length} kolumner</div>
                            </div>`;
                    }
                    html += '</div>';
                }

                listEl.innerHTML = html || '<div class="empty-state">Inga tabeller hittades</div>';

                // Add click handlers
                listEl.querySelectorAll('.table-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.table-item.selected').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                        loadTableData(item.dataset.schema, item.dataset.table, item.dataset.hasGeo === 'true');
                    });
                });

            } catch (err) {
                listEl.innerHTML = `<div class="empty-state">Fel: ${err.message}</div>`;
            }
        }

        // Load table data
        async function loadTableData(schema, table, hasGeometry, offset = 0) {
            currentTable = { schema, table, hasGeometry };
            currentOffset = offset;

            const wrapper = document.getElementById('dataTableWrapper');
            const title = document.getElementById('dataTitle');
            const pagination = document.getElementById('pagination');

            title.textContent = `${schema}.${table}`;
            wrapper.innerHTML = '<div class="loading"><div class="spinner"></div>Laddar...</div>';

            try {
                const response = await fetch(`/api/explorer/tables/${schema}/${table}?limit=${pageSize}&offset=${offset}`);
                const data = await response.json();

                if (data.error) {
                    wrapper.innerHTML = `<div class="empty-state">Fel: ${data.error}</div>`;
                    return;
                }

                // Build table
                let html = '<table><thead><tr>';
                for (const col of data.columns) {
                    html += `<th>${col.name}<span class="col-type">${col.type}</span></th>`;
                }
                html += '</tr></thead><tbody>';

                for (const row of data.rows) {
                    html += '<tr>';
                    for (const col of data.columns) {
                        const val = row[col.name];
                        const displayVal = val === null ? '<em style="color:var(--text-muted)">NULL</em>' :
                            String(val).length > 100 ? String(val).substring(0, 100) + '...' : val;
                        html += `<td title="${String(val).replace(/"/g, '&quot;')}">${displayVal}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</tbody></table>';

                wrapper.innerHTML = html;

                // Update pagination
                const start = offset + 1;
                const end = Math.min(offset + data.rows.length, data.total);
                document.getElementById('paginationInfo').textContent = `Visar ${start}-${end} av ${data.total.toLocaleString()}`;

                document.getElementById('btnPrev').disabled = offset === 0;
                document.getElementById('btnNext').disabled = offset + pageSize >= data.total;

                pagination.style.display = 'flex';

                // Enable buttons
                document.getElementById('btnRefresh').disabled = false;
                document.getElementById('btnExportCsv').disabled = false;

                // Load geometry if available
                if (hasGeometry) {
                    loadGeometry(schema, table);
                    document.getElementById('btnFitBounds').disabled = false;
                } else {
                    geoJsonLayer.clearLayers();
                    document.getElementById('btnFitBounds').disabled = true;
                }

            } catch (err) {
                wrapper.innerHTML = `<div class="empty-state">Fel: ${err.message}</div>`;
            }
        }

        // Load geometry for map
        async function loadGeometry(schema, table) {
            const sourceCrs = document.getElementById('sourceCrs').value;

            try {
                const response = await fetch(
                    `/api/explorer/tables/${schema}/${table}/geojson?limit=5000&source_crs=${encodeURIComponent(sourceCrs)}`
                );
                const geojson = await response.json();

                if (geojson.error) {
                    console.error('GeoJSON error:', geojson.error);
                    alert(`Fel vid laddning av geometri: ${geojson.error}`);
                    return;
                }

                geoJsonLayer.clearLayers();
                geoJsonLayer.addData(geojson);

                // Fit bounds if we have features
                if (geojson.features.length > 0) {
                    const bounds = geoJsonLayer.getBounds();
                    if (bounds.isValid()) {
                        map.fitBounds(bounds, { padding: [20, 20] });
                    }
                }

            } catch (err) {
                console.error('Failed to load geometry:', err);
            }
        }

        // Run custom SQL query
        async function runQuery() {
            const sql = document.getElementById('sqlInput').value.trim();
            if (!sql) return;

            const wrapper = document.getElementById('dataTableWrapper');
            const title = document.getElementById('dataTitle');

            title.textContent = 'SQL-resultat';
            wrapper.innerHTML = '<div class="loading"><div class="spinner"></div>K√∂r fr√•ga...</div>';
            document.getElementById('pagination').style.display = 'none';

            try {
                const response = await fetch('/api/explorer/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql })
                });

                const data = await response.json();

                if (data.error) {
                    wrapper.innerHTML = `<div class="empty-state" style="color: var(--error);">Fel: ${data.error}</div>`;
                    return;
                }

                // Build table
                let html = '<table><thead><tr>';
                for (const col of data.columns) {
                    html += `<th>${col}</th>`;
                }
                html += '</tr></thead><tbody>';

                for (const row of data.rows) {
                    html += '<tr>';
                    for (const col of data.columns) {
                        const val = row[col];
                        const displayVal = val === null ? '<em style="color:var(--text-muted)">NULL</em>' : val;
                        html += `<td>${displayVal}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</tbody></table>';

                wrapper.innerHTML = html;
                title.textContent = `SQL-resultat (${data.row_count} rader)`;

            } catch (err) {
                wrapper.innerHTML = `<div class="empty-state">Fel: ${err.message}</div>`;
            }
        }

        // Export to CSV
        function exportCsv() {
            if (!currentTable) return;

            const table = document.querySelector('.data-table-wrapper table');
            if (!table) return;

            const rows = [];
            const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.split('\n')[0]);
            rows.push(headers.join(','));

            table.querySelectorAll('tbody tr').forEach(tr => {
                const cells = Array.from(tr.querySelectorAll('td')).map(td => {
                    let val = td.textContent;
                    if (val.includes(',') || val.includes('"') || val.includes('\n')) {
                        val = '"' + val.replace(/"/g, '""') + '"';
                    }
                    return val;
                });
                rows.push(cells.join(','));
            });

            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentTable.schema}_${currentTable.table}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Event handlers
        document.getElementById('btnRunQuery').addEventListener('click', runQuery);
        document.getElementById('sqlInput').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                runQuery();
            }
        });

        document.getElementById('btnRefresh').addEventListener('click', () => {
            if (currentTable) {
                loadTableData(currentTable.schema, currentTable.table, currentTable.hasGeometry, currentOffset);
            }
        });

        document.getElementById('btnExportCsv').addEventListener('click', exportCsv);

        document.getElementById('btnPrev').addEventListener('click', () => {
            if (currentTable && currentOffset > 0) {
                loadTableData(currentTable.schema, currentTable.table, currentTable.hasGeometry, currentOffset - pageSize);
            }
        });

        document.getElementById('btnNext').addEventListener('click', () => {
            if (currentTable) {
                loadTableData(currentTable.schema, currentTable.table, currentTable.hasGeometry, currentOffset + pageSize);
            }
        });

        document.getElementById('btnFitBounds').addEventListener('click', () => {
            if (geoJsonLayer.getLayers().length > 0) {
                const bounds = geoJsonLayer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [20, 20] });
                }
            }
        });

        document.getElementById('btnReloadGeo').addEventListener('click', () => {
            if (currentTable && currentTable.hasGeometry) {
                loadGeometry(currentTable.schema, currentTable.table);
            }
        });

        document.getElementById('sourceCrs').addEventListener('change', () => {
            if (currentTable && currentTable.hasGeometry) {
                loadGeometry(currentTable.schema, currentTable.table);
            }
        });

        // Initialize
        initMap();
        loadTables();

        // Fix Leaflet map size after layout is complete
        setTimeout(() => map.invalidateSize(), 100);
        window.addEventListener('resize', () => map.invalidateSize());
    </script>
</body>
</html>
