version: '3'

tasks:
  check:
    desc: Kontrollera status innan release
    cmds:
      - echo "=== Git status ==="
      - git status --short
      - echo ""
      - echo "=== Senaste tags ==="
      - git tag --sort=-v:refname | head -5
      - echo ""
      - echo "=== Senaste commits ==="
      - git log --oneline -5

  new:
    desc: "Skapa ny release (ex: task release:new -- v0.1.2)"
    vars:
      VERSION: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.VERSION}}" ]'
        msg: "Fel: Ange version som argument. Exempel: task release:new -- v0.1.2"
      - sh: git diff --quiet
        msg: "Fel: Det finns uncommittade ändringar! Committa först."
      - sh: git diff --cached --quiet
        msg: "Fel: Det finns staged ändringar! Committa först."
      - sh: command -v gh >/dev/null
        msg: "Fel: GitHub CLI (gh) krävs. Installera med: brew install gh"
    cmds:
      - echo "=== Skapar release {{.VERSION}} ==="
      - echo ""
      - echo "1. Skapar GitHub Release med tag..."
      - gh release create {{.VERSION}} --title "{{.VERSION}}" --generate-notes
      - echo ""
      - echo "=== Release {{.VERSION}} skapad! ==="
      - echo ""
      - echo "GitHub Actions bygger nu binärerna automatiskt."
      - cmd: echo "Följ bygget på https://github.com/10gbrand/g-etl/actions"
      - echo ""
      - cmd: echo "Binärerna laddas upp till https://github.com/10gbrand/g-etl/releases/tag/{{.VERSION}}"

  delete:
    desc: "Ta bort en release (ex: task release:delete -- v0.1.2)"
    vars:
      VERSION: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.VERSION}}" ]'
        msg: "Fel: Ange version som argument. Exempel: task release:delete -- v0.1.2"
      - sh: command -v gh >/dev/null
        msg: "Fel: GitHub CLI (gh) krävs. Installera med: brew install gh"
    cmds:
      - echo "Tar bort GitHub Release {{.VERSION}}..."
      - gh release delete {{.VERSION}} --yes || true
      - echo "Tar bort lokal tag {{.VERSION}}..."
      - git tag -d {{.VERSION}} || true
      - echo "Tar bort remote tag {{.VERSION}}..."
      - cmd: git push origin :refs/tags/{{.VERSION}} || true
      - echo "Klar!"

  smoketest:
    desc: Lokalt smoke test - verifiera att appen startar utan exkluderade paket (pyogrio, pyarrow, etc.)
    cmds:
      - |
        echo "=== Smoke test: importerar app utan exkluderade paket ==="
        PYTHONPATH=src uv run python -c "
        import sys

        # Blockera samma paket som Nuitka exkluderar
        blocked = [
            'geopandas', 'pandas', 'pyarrow', 'pyogrio',
            'shapely', 'fiona', 'numpy', 'scipy', 'pyodbc',
        ]

        class BlockImporter:
            def find_module(self, name, path=None):
                if name.split('.')[0] in blocked:
                    return self
            def load_module(self, name):
                raise ModuleNotFoundError(f'BLOCKED by smoke test: {name}')

        sys.meta_path.insert(0, BlockImporter())

        # Importera appen (samma entry point som Nuitka bygger)
        from g_etl.admin import app
        print('OK: Alla imports klarade smoke test!')
        "
    silent: true

  trigger:
    desc: "Trigga bygge för befintlig tag (ex: task release:trigger -- v0.1.2)"
    vars:
      VERSION: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.VERSION}}" ]'
        msg: "Fel: Ange version som argument. Exempel: task release:trigger -- v0.1.2"
      - sh: command -v gh >/dev/null
        msg: "Fel: GitHub CLI (gh) krävs. Installera med: brew install gh"
    cmds:
      - echo "Skapar GitHub Release för befintlig tag {{.VERSION}}..."
      - gh release create {{.VERSION}} --title "{{.VERSION}}" --generate-notes
      - echo ""
      - echo "GitHub Actions triggas nu!"
      - cmd: echo "Följ bygget på https://github.com/10gbrand/g-etl/actions"
