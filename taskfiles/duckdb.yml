version: '3'

vars:
  DB_FILE: data/warehouse.duckdb
  INIT_FILE: .duckdbrc

tasks:
  cli:
    desc: Öppna DuckDB CLI (med extensions)
    cmds:
      - duckdb -init {{.INIT_FILE}} {{.DB_FILE}}

  cli-raw:
    desc: Öppna DuckDB CLI (utan init)
    cmds:
      - duckdb {{.DB_FILE}}

  query:
    desc: Kör en SQL-fråga (task db:query -- SELECT 1)
    cmds:
      - duckdb -init {{.INIT_FILE}} {{.DB_FILE}} -c "{{.CLI_ARGS}}"

  init:
    desc: Initiera databas med extensions, scheman och makron
    cmds:
      - |
        echo "Kör alla init-filer i en session..."
        cat sql/_init/*.sql | duckdb {{.DB_FILE}}
      - echo "Databas initierad"

  run-sql:
    desc: Kör en SQL-fil (task db:run-sql -- sql/staging/dataset/01_clean.sql)
    cmds:
      - duckdb -init {{.INIT_FILE}} {{.DB_FILE}} < "{{.CLI_ARGS}}"

  migrate:
    desc: Kör alla migrationer i ordning
    cmds:
      - |
        for f in migrations/*.sql; do
          echo "Kör: $f"
          duckdb {{.DB_FILE}} < "$f"
        done

  migrate-new:
    desc: Skapa ny migration (task db:migrate-new -- namn)
    cmds:
      - |
        timestamp=$(date +%Y%m%d%H%M%S)
        filename="migrations/${timestamp}_{{.CLI_ARGS}}.sql"
        echo "-- Migration: {{.CLI_ARGS}}" > "$filename"
        echo "-- Created: $(date +%Y-%m-%d)" >> "$filename"
        echo "-- Description: " >> "$filename"
        echo "" >> "$filename"
        echo "Skapad: $filename"

  migrate-status:
    desc: Visa körda migrationer
    cmds:
      - duckdb {{.DB_FILE}} "SELECT * FROM _migrations ORDER BY id;"

  extensions:
    desc: Visa installerade extensions
    cmds:
      - duckdb {{.DB_FILE}} "SELECT extension_name, loaded, installed FROM duckdb_extensions() WHERE installed;"

  schemas:
    desc: Visa schemas i databasen
    cmds:
      - duckdb {{.DB_FILE}} "SELECT schema_name FROM information_schema.schemata;"

  tables:
    desc: Visa alla tabeller
    cmds:
      - duckdb {{.DB_FILE}} "SELECT table_schema, table_name FROM information_schema.tables WHERE table_schema NOT IN ('information_schema', 'pg_catalog');"
